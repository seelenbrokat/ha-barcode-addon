<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WOG Barcode App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui,sans-serif; background: #f3f9f4; margin: 0; }
    header { background: #21b573; color: #fff; padding: 1.1rem 0.8rem 0.8rem 0.8rem; text-align: center; border-bottom-left-radius: 1.1rem; border-bottom-right-radius: 1.1rem;}
    .container { max-width: 350px; margin: 1.3rem auto; padding: 1.3rem 0.7rem 1.2rem 0.7rem; background: #fff; border-radius: 1.2rem; box-shadow: 0 2px 10px #0001;}
    .tabs { display: flex; justify-content: space-between; margin-bottom: 1.0rem;}
    .tab { flex: 1 1 0; text-align: center; padding: 0.7rem 0.1rem; cursor: pointer; font-size: 0.9rem; background: #eafbf2; color: #18965a; border-radius: 0.9rem; margin: 0 0.15rem; transition: background 0.14s;}
    .tab.active { background: #21b573; color: #fff; font-weight: bold;}
    .formrow { margin-bottom: 1.0rem;}
    .bigscan { background: #21b573; color: #fff; font-size: 1.55rem; font-weight: bold; border-radius: 1.1rem; padding: 1.1rem 0; border: none; width: 100%; margin-bottom: 0.7rem; box-shadow: 0 1px 10px #21b57322; cursor: pointer; transition: background 0.18s;}
    .bigscan:active { background: #18965a; }
    .dropdown { width: 100%; padding: 0.7rem; border-radius: 0.7rem; border: 1.2px solid #cdeede; margin-bottom: 0.9rem; font-size: 0.92rem;}
    input[type="text"] { width: 100%; padding: 0.9rem; border-radius: 0.8rem; border: 1.2px solid #cdeede; font-size: 0.95rem;}
    .status-ok { background: #eafbf2; color: #18965a; border-left: 5px solid #21b573; padding: 0.7rem; border-radius: 0.7rem; font-size: 0.92rem;}
    .status-error { background: #fff3f4; color: #ba2121; border-left: 5px solid #e74c3c; padding: 0.7rem; border-radius: 0.7rem; font-size: 0.92rem;}
    .lastscans { margin-top: 1.2rem;}
    .scanlist { list-style: none; margin: 0; padding: 0;}
    .scanitem { padding: 0.5rem 0.5rem 0.5rem 0.7rem; border-bottom: 1px solid #eee; font-size: 0.87rem;}
    .scanitem.ok { color: #21b573;}
    .scanitem.fail { color: #e74c3c;}
    .row { display: flex; gap: 0.6rem; }
    .row > * { flex: 1; }
    @media (max-width:500px) {
      .container { padding: 0.6rem 0.02rem 0.8rem 0.02rem; }
      header { padding: 0.7rem 0.12rem 0.5rem 0.12rem; }
      .bigscan { font-size: 1.15rem; }
    }
  </style>
</head>
<body>
  <header>
    <img src="WOG_AG-removebg-preview.png" alt="WOG Logo" style="display:block;margin:0 auto 0.35rem auto;max-width:90px;">
    <h2 style="font-size:1.27rem;margin-bottom:0.18rem;margin-top:0.2rem;">WOG Barcode</h2>
    <div style="font-size:0.88rem; font-weight:400;">Scannen & Statusrückmeldung</div>
  </header>
  <div class="container">
    <div class="tabs">
      <div class="tab active" id="tab-scan" onclick="switchTab('scan')">Scanner</div>
      <div class="tab" id="tab-hallen" onclick="switchTab('hallen')">Hallenscan</div>
      <div class="tab" id="tab-setstatus" onclick="switchTab('setstatus')">Status setzen</div>
    </div>

    <!-- Zusätzliche Felder: Location und User -->
    <div class="formrow row">
      <select id="user-location" class="dropdown" style="max-width:200px;">
        <option value="ikea halle">ikea halle</option>
        <option value="pickup halle">pickup halle</option>
        <option value="pickup feldkirch">pickup feldkirch</option>
      </select>
      <input type="text" id="user-field" value="3" style="max-width:80px;" placeholder="User">
    </div>

    <form id="form-scan" class="formrow" onsubmit="scanBarcode(event)">
      <input type="text" id="scan-barcode" name="sscc" placeholder="Barcode/SSCC eingeben oder scannen"
        autocomplete="off" required autofocus oninput="autoSubmitScan()">
      <button class="bigscan" type="submit">Barcode scannen</button>
    </form>

    <form id="form-hallen" class="formrow" style="display:none;" onsubmit="scanStatus(event)">
      <select id="hallen-status" class="dropdown">
        <option>Hallenscan</option>
        <option>Wareneingang</option>
        <option>Warenausgang</option>
        <option>Retoure</option>
      </select>
      <input type="text" id="hallen-barcode" placeholder="Barcode/SSCC eingeben oder scannen" autocomplete="off" required>
      <button class="bigscan" type="submit">Hallenscan</button>
    </form>

    <form id="form-setstatus" class="formrow" style="display:none;" onsubmit="setManualStatus(event)">
      <input type="text" id="manual-barcode" placeholder="SSCC eingeben" autocomplete="off" required>
      <select id="manual-status" class="dropdown">
        <option>Hallenscan</option>
        <option>Wareneingang</option>
        <option>Warenausgang</option>
        <option>Retoure</option>
      </select>
      <button class="bigscan" type="submit">Status setzen</button>
    </form>

    <div id="feedback"></div>
    <div class="lastscans">
      <b>Letzte Scans:</b>
      <ul class="scanlist" id="scanlist"></ul>
    </div>
  </div>

  <script>
    const BASE = window.location.pathname.replace(/\/$/, '');

    function switchTab(tab) {
      document.getElementById('tab-scan').classList.remove('active');
      document.getElementById('tab-hallen').classList.remove('active');
      document.getElementById('tab-setstatus').classList.remove('active');
      document.getElementById('form-scan').style.display = 'none';
      document.getElementById('form-hallen').style.display = 'none';
      document.getElementById('form-setstatus').style.display = 'none';
      document.getElementById('feedback').innerHTML = "";

      if(tab === 'scan') {
        document.getElementById('tab-scan').classList.add('active');
        document.getElementById('form-scan').style.display = 'block';
        setTimeout(() => document.getElementById('scan-barcode').focus(), 100);
      } else if(tab === 'hallen') {
        document.getElementById('tab-hallen').classList.add('active');
        document.getElementById('form-hallen').style.display = 'block';
        setTimeout(() => document.getElementById('hallen-barcode').focus(), 100);
      } else if(tab === 'setstatus') {
        document.getElementById('tab-setstatus').classList.add('active');
        document.getElementById('form-setstatus').style.display = 'block';
        setTimeout(() => document.getElementById('manual-barcode').focus(), 100);
      }
    }

    function autoSubmitScan() {
      const input = document.getElementById('scan-barcode');
      if (input.value.length >= 8) {
        if (!window.lastScanValue || window.lastScanValue !== input.value) {
          window.lastScanValue = input.value;
          document.getElementById('form-scan').requestSubmit();
        }
      }
    }

    function getUserLocation() {
      const location = document.getElementById('user-location').value;
      const user = document.getElementById('user-field').value;
      return { location, user };
    }

    function scanBarcode(event) {
      event.preventDefault();
      const input = document.getElementById('scan-barcode');
      const barcode = input.value.trim();
      fetch(`${BASE}/scan`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ barcode })
      })
      .then(r => r.json()).then(data => {
        if(data.found === false) {
          feedback("Kein Treffer: " + barcode, false);
          addScan(barcode, "Scanner", false, "Nicht gefunden");
        } else if(data.found === true) {
          let infos = "";
          if (data.empfaenger || data.zustelldatum || data.collianzahl) {
            infos = "<br><b>Empfänger:</b> " + (data.empfaenger || "-") +
                    "<br><b>Zustelldatum:</b> " + (data.zustelldatum || "-") +
                    "<br><b>Collianzahl:</b> " + (data.collianzahl || "-") +
                    (data.auftraggeber ? "<br><b>Auftraggeber:</b> " + data.auftraggeber : "") +
                    (data.gewicht ? "<br><b>Gewicht:</b> " + data.gewicht : "");
          }
          feedback("Scan erfolgreich: " + barcode + infos, true);
          addScan(barcode, "Scanner", true, "");
        } else {
          feedback("Unbekannte Antwort vom Server!", false);
          addScan(barcode, "Scanner", false, "Serverantwort unklar");
        }
        input.value = "";
        input.focus();
        window.lastScanValue = null;
      }).catch(e => {
        feedback("Serverfehler!", false);
        input.value = "";
        input.focus();
        window.lastScanValue = null;
      });
    }

    // Gefixte Version: Feedback erscheint immer, auch bei Fehlern!
    function scanStatus(event) {
      event.preventDefault();
      const input = document.getElementById('hallen-barcode');
      const sscc = input.value.trim();
      const status = document.getElementById('hallen-status').value;
      const { location, user } = getUserLocation();
      fetch(`${BASE}/scan_status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sscc, status, location, user })
      })
      .then(r => r.json()).then(data => {
        if(data && typeof data.ok !== "undefined") {
          if(data.ok) {
            feedback("Status übertragen: " + sscc + " ("+status+")", true);
            addScan(sscc, status, true, "");
          } else {
            feedback("Fehler beim Übertragen: " + (data.error || ""), false);
            addScan(sscc, status, false, data.error || "");
          }
        } else {
          feedback("Unerwartete Antwort vom Server.", false);
          addScan(sscc, status, false, "Unerwartete Serverantwort");
        }
        input.value = "";
        input.focus();
      }).catch(e => {
        feedback("Serverfehler!", false);
        input.value = "";
        input.focus();
      });
    }

    // Gefixte Version: Feedback erscheint immer, auch bei Fehlern!
    function setManualStatus(event) {
      event.preventDefault();
      const input = document.getElementById('manual-barcode');
      const sscc = input.value.trim();
      const status = document.getElementById('manual-status').value;
      const { location, user } = getUserLocation();
      fetch(`${BASE}/set_status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sscc, status, location, user })
      })
      .then(r => r.json()).then(data => {
        if(data && typeof data.ok !== "undefined") {
          if(data.ok) {
            feedback("Status gesetzt: " + sscc + " ("+status+")", true);
            addScan(sscc, status, true, "");
          } else {
            feedback("Fehler beim Setzen: " + (data.error || ""), false);
            addScan(sscc, status, false, data.error || "");
          }
        } else {
          feedback("Unerwartete Antwort vom Server.", false);
          addScan(sscc, status, false, "Unerwartete Serverantwort");
        }
        input.value = "";
        input.focus();
      }).catch(e => {
        feedback("Serverfehler!", false);
        input.value = "";
        input.focus();
      });
    }

    function feedback(msg, ok) {
      document.getElementById('feedback').innerHTML = '<div class="status-' + (ok ? 'ok' : 'error') + '">' + msg + '</div>';
    }

    let lastScans = [];
    function addScan(sscc, status, ok, msg) {
      lastScans.unshift({sscc, status, ok, msg});
      if (lastScans.length > 10) lastScans = lastScans.slice(0, 10);
      renderScanlist();
    }
    function renderScanlist() {
      let html = "";
      lastScans.forEach(scan => {
        html += `<li class="scanitem ${scan.ok ? 'ok' : 'fail'}">${scan.sscc} · ${scan.status} · ` +
                (
                  scan.ok
                    ? (scan.status === "Scanner" ? "<b>Gefunden</b>" : "<b>Übertragen</b>")
                    : "<b>Fehler</b> " + (scan.msg||"")
                ) +
                `</li>`;
      });
      document.getElementById('scanlist').innerHTML = html;
    }

    window.onload = () => {
      setTimeout(() => document.getElementById('scan-barcode').focus(), 100);
    };
  </script>
</body>
</html>
