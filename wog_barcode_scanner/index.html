<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>WOG Barcode App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui,sans-serif; background: #f3f9f4; margin: 0; }
    header { background: #21b573; color: #fff; padding: 1.4rem 1rem 1rem 1rem; text-align: center; border-bottom-left-radius: 1.5rem; border-bottom-right-radius: 1.5rem;}
    .container { max-width: 430px; margin: 2.2rem auto; padding: 2.1rem 1.2rem 2rem 1.2rem; background: #fff; border-radius: 1.6rem; box-shadow: 0 4px 20px #0001;}
    .tabs { display: flex; justify-content: space-between; margin-bottom: 1.6rem;}
    .tab { flex: 1 1 0; text-align: center; padding: 1rem 0.2rem; cursor: pointer; font-size: 1.15rem; background: #eafbf2; color: #18965a; border-radius: 1.2rem; margin: 0 0.3rem; transition: background 0.14s;}
    .tab.active { background: #21b573; color: #fff; font-weight: bold;}
    .formrow { margin-bottom: 1.5rem;}
    .bigscan { background: #21b573; color: #fff; font-size: 2.0rem; font-weight: bold; border-radius: 1.5rem; padding: 1.6rem 0; border: none; width: 100%; margin-bottom: 1.1rem; box-shadow: 0 1px 12px #21b57333; cursor: pointer; transition: background 0.18s;}
    .bigscan:active { background: #18965a; }
    .dropdown { width: 100%; padding: 1rem; border-radius: 1rem; border: 1.5px solid #cdeede; margin-bottom: 1.3rem; font-size: 1.13rem;}
    input[type="text"] { width: 100%; padding: 1.1rem; border-radius: 1rem; border: 1.5px solid #cdeede; font-size: 1.15rem;}
    .status-ok { background: #eafbf2; color: #18965a; border-left: 7px solid #21b573; padding: 1rem; border-radius: 1rem; font-size: 1.13rem;}
    .status-error { background: #fff3f4; color: #ba2121; border-left: 7px solid #e74c3c; padding: 1rem; border-radius: 1rem; font-size: 1.13rem;}
    .lastscans { margin-top: 2.1rem;}
    .scanlist { list-style: none; margin: 0; padding: 0;}
    .scanitem { padding: 0.7rem 0.7rem 0.7rem 1rem; border-bottom: 1px solid #eee; font-size: 1rem;}
    .scanitem.ok { color: #21b573;}
    .scanitem.fail { color: #e74c3c;}
    @media (max-width:500px) {
      .container { padding: 1.0rem 0.1rem 1.2rem 0.1rem; }
      header { padding: 1rem 0.2rem 0.6rem 0.2rem; }
    }
  </style>
</head>
<body>
  <header>
    <img src="WOG_AG-removebg-preview.png" alt="WOG Logo" style="display:block;margin:0 auto 0.5rem auto;max-width:130px;">
    <h2>WOG Barcode</h2>
    <div style="font-size:1rem; font-weight:400;">Scannen & Statusrückmeldung</div>
  </header>
  <div class="container">
    <div class="tabs">
      <div class="tab active" id="tab-scan" onclick="switchTab('scan')">Scanner</div>
      <div class="tab" id="tab-hallen" onclick="switchTab('hallen')">Hallenscan</div>
      <div class="tab" id="tab-setstatus" onclick="switchTab('setstatus')">Status setzen</div>
    </div>

    <form id="form-scan" class="formrow" onsubmit="scanBarcode(event)">
      <input type="text" id="scan-barcode" name="sscc" placeholder="Barcode/SSCC eingeben oder scannen" autocomplete="off" required autofocus>
      <button class="bigscan" type="submit">Barcode scannen</button>
    </form>

    <form id="form-hallen" class="formrow" style="display:none;" onsubmit="scanStatus(event)">
      <select id="hallen-status" class="dropdown">
        <option>Hallenscan</option>
        <option>Wareneingang</option>
        <option>Warenausgang</option>
        <option>Retoure</option>
      </select>
      <input type="text" id="hallen-barcode" placeholder="Barcode/SSCC eingeben oder scannen" autocomplete="off" required>
      <button class="bigscan" type="submit">Hallenscan</button>
    </form>

    <form id="form-setstatus" class="formrow" style="display:none;" onsubmit="setManualStatus(event)">
      <input type="text" id="manual-barcode" placeholder="SSCC eingeben" autocomplete="off" required>
      <select id="manual-status" class="dropdown">
        <option>Hallenscan</option>
        <option>Wareneingang</option>
        <option>Warenausgang</option>
        <option>Retoure</option>
      </select>
      <button class="bigscan" type="submit">Status setzen</button>
    </form>

    <div id="feedback"></div>
    <div class="lastscans">
      <b>Letzte Scans:</b>
      <ul class="scanlist" id="scanlist"></ul>
    </div>
  </div>

  <script>
    const BASE = window.location.pathname.replace(/\/$/, '');

    function switchTab(tab) {
      document.getElementById('tab-scan').classList.remove('active');
      document.getElementById('tab-hallen').classList.remove('active');
      document.getElementById('tab-setstatus').classList.remove('active');
      document.getElementById('form-scan').style.display = 'none';
      document.getElementById('form-hallen').style.display = 'none';
      document.getElementById('form-setstatus').style.display = 'none';
      document.getElementById('feedback').innerHTML = "";

      if(tab === 'scan') {
        document.getElementById('tab-scan').classList.add('active');
        document.getElementById('form-scan').style.display = 'block';
        document.getElementById('scan-barcode').focus();
      } else if(tab === 'hallen') {
        document.getElementById('tab-hallen').classList.add('active');
        document.getElementById('form-hallen').style.display = 'block';
        document.getElementById('hallen-barcode').focus();
      } else if(tab === 'setstatus') {
        document.getElementById('tab-setstatus').classList.add('active');
        document.getElementById('form-setstatus').style.display = 'block';
        document.getElementById('manual-barcode').focus();
      }
    }

    function scanBarcode(event) {
      event.preventDefault();
      const barcode = document.getElementById('scan-barcode').value.trim();
      fetch(`${BASE}/scan`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ barcode })
      })
      .then(r => r.json()).then(data => {
        if(data.found) {
          let infos = "";
          if (data.empfaenger || data.zustelldatum || data.collianzahl) {
            infos = "<br><b>Empfänger:</b> " + (data.empfaenger || "-") +
                    "<br><b>Zustelldatum:</b> " + (data.zustelldatum || "-") +
                    "<br><b>Collianzahl:</b> " + (data.collianzahl || "-") +
                    // Weitere Felder wie Auftraggeber und Gewicht hier hinzufügen:
                    (data.auftraggeber ? "<br><b>Auftraggeber:</b> " + data.auftraggeber : "") +
                    (data.gewicht ? "<br><b>Gewicht:</b> " + data.gewicht : "");
          }
          feedback("Scan erfolgreich: " + barcode + infos, true);
          addScan(barcode, "Scanner", true, "");
        } else {
          feedback("Kein Treffer: " + barcode, false);
          addScan(barcode, "Scanner", false, "Nicht gefunden");
        }
      }).catch(e => {
        feedback("Serverfehler!", false);
      });
      document.getElementById('scan-barcode').value = "";
      document.getElementById('scan-barcode').focus();
    }

    function scanStatus(event) {
      event.preventDefault();
      const sscc = document.getElementById('hallen-barcode').value.trim();
      const status = document.getElementById('hallen-status').value;
      fetch(`${BASE}/scan_status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sscc, status })
      })
      .then(r => r.json()).then(data => {
        if(data.ok) {
          feedback("Status übertragen: " + sscc + " ("+status+")", true);
          addScan(sscc, status, true, "");
        } else {
          feedback("Fehler beim Übertragen: " + (data.error || ""), false);
          addScan(sscc, status, false, data.error || "");
        }
      }).catch(e => {
        feedback("Serverfehler!", false);
      });
      document.getElementById('hallen-barcode').value = "";
      document.getElementById('hallen-barcode').focus();
    }

    function setManualStatus(event) {
      event.preventDefault();
      const sscc = document.getElementById('manual-barcode').value.trim();
      const status = document.getElementById('manual-status').value;
      fetch(`${BASE}/set_status`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ sscc, status })
      })
      .then(r => r.json()).then(data => {
        if(data.ok) {
          feedback("Status gesetzt: " + sscc + " ("+status+")", true);
          addScan(sscc, status, true, "");
        } else {
          feedback("Fehler beim Setzen: " + (data.error || ""), false);
          addScan(sscc, status, false, data.error || "");
        }
      }).catch(e => {
        feedback("Serverfehler!", false);
      });
      document.getElementById('manual-barcode').value = "";
      document.getElementById('manual-barcode').focus();
    }

    function feedback(msg, ok) {
      document.getElementById('feedback').innerHTML = '<div class="status-' + (ok ? 'ok' : 'error') + '">' + msg + '</div>';
    }

    let lastScans = [];
    function addScan(sscc, status, ok, msg) {
      lastScans.unshift({sscc, status, ok, msg});
      if (lastScans.length > 10) lastScans = lastScans.slice(0, 10);
      renderScanlist();
    }
    function renderScanlist() {
      let html = "";
      lastScans.forEach(scan => {
        html += `<li class="scanitem ${scan.ok ? 'ok' : 'fail'}">${scan.sscc} · ${scan.status} · ` +
                (scan.ok ? "<b>Übertragen</b>" : "<b>Fehler</b> " + (scan.msg||"")) +
                `</li>`;
      });
      document.getElementById('scanlist').innerHTML = html;
    }

    // Beim Laden direkt auf das Feld fokussieren:
    window.onload = () => {
      document.getElementById('scan-barcode').focus();
    };
  </script>
</body>
</html>
