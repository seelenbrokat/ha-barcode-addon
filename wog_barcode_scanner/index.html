<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>WOG Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; background: #f9f9f9; }
    input[type="text"] { padding: 0.5rem; width: 300px; font-size: 1rem; }
    button { padding: 0.5rem 1rem; font-size: 1rem; margin-left: 0.5rem; }
    .result, .last-scans { margin-top: 1rem; padding: 1rem; background: white; border-radius: 6px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
    .last-scans div { border-bottom: 1px solid #eee; padding: 0.5rem 0; }
    .last-scans div:last-child { border-bottom: none; }
  </style>
</head>
<body>

<h1>WOG Barcode Scanner</h1>

<label for="barcode-input">Barcode scannen oder eingeben:</label><br />
<input type="text" id="barcode-input" autocomplete="off" />
<button id="scan-btn">Scannen</button>

<div class="result" id="result"></div>

<h2>Letzte Scans</h2>
<div class="last-scans" id="last-scans"></div>

<script>
  async function scanBarcode(barcode) {
    if (!barcode) return;

    const resultDiv = document.getElementById('result');
    resultDiv.textContent = 'Lade...';

    try {
      const response = await fetch('/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ barcode })
      });

      if (!response.ok) {
        const error = await response.json();
        resultDiv.textContent = 'Fehler: ' + (error.error || 'Unbekannter Fehler');
        return;
      }

      const data = await response.json();

      if (!data.found) {
        resultDiv.textContent = `Kein Datensatz für Barcode "${barcode}" gefunden.`;
        return;
      }

      const d = data.data || {};
      resultDiv.innerHTML = `
        <strong>Barcode:</strong> ${barcode}<br />
        <strong>Empfänger:</strong> ${d.Recipient || d.EmpfName1 || 'n/a'}<br />
        <strong>Lieferdatum:</strong> ${d.DeliveryDate || 'n/a'}<br />
        <strong>Auftragsnummer:</strong> ${d.OrderNumber || d.TransportOrderNumber || 'n/a'}<br />
        <strong>Menge:</strong> ${d.Quantity || d.Colli || 'n/a'}
      `;

      loadLastScans();

    } catch (err) {
      resultDiv.textContent = 'Fehler beim Scannen: ' + err.message;
    }
  }

  async function loadLastScans() {
    const lastScansDiv = document.getElementById('last-scans');
    try {
      const response = await fetch('/last_scans');
      if (!response.ok) throw new Error('Fehler beim Laden der letzten Scans');
      const lastScans = await response.json();

      if (!lastScans.length) {
        lastScansDiv.textContent = 'Noch keine Scans vorhanden.';
        return;
      }

      lastScansDiv.innerHTML = '';
      lastScans.forEach(scan => {
        const b = scan.barcode;
        const found = scan.result.found ? '✔️' : '❌';
        lastScansDiv.innerHTML += `<div>${found} Barcode: <strong>${b}</strong></div>`;
      });
    } catch {
      lastScansDiv.textContent = 'Fehler beim Laden der letzten Scans.';
    }
  }

  document.getElementById('scan-btn').addEventListener('click', () => {
    const barcode = document.getElementById('barcode-input').value.trim();
    scanBarcode(barcode);
  });

  document.getElementById('barcode-input').addEventListener('keyup', (e) => {
    if (e.key === 'Enter') {
      scanBarcode(e.target.value.trim());
    }
  });

  window.onload = loadLastScans;
</script>

</body>
</html>
